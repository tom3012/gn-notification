<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-material/paper-material.html">
<!-- <link rel="import" href="../iron-swipeable-container/iron-swipeable-container.html"> -->
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="gn-route-notification.html">

<!--
An element providing notifications for the GreenNavigation WebApp.

Example:

    <paper-button raised onclick="hint.open()">hint notification</paper-button>

    <gn-notification  id="hint" title="Hint">This is a hint message.</gn-notification>

Example:

    <paper-button raised onclick="warning.open()">warning notification</paper-button>
    <paper-button raised onclick="error.open()">error notification</paper-button>

    <gn-notification  id="warning" warning title="Warning">
      Oh, oh... there is a warning message.
    </gn-notification>

    <gn-notification  id="error" error title="Error">
      An error has occurred
    </gn-notification>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="gn-notification-container">
  <template>
    <style is="custom-style" include="iron-flex">
      :host {
        position: relative;

        @apply(--layout-vertical);
      }

      #directions {
        background-color: #00960a;
        color: #fff;
        font-size: 1.2em;
        font-weight: bold;
        height: 55px;
        padding: 10px;
        position: relative;

        @apply(--layout-horizontal);
      }

      .distance {
        font-size: 2.2em;
      }

      #left-container {
        @apply(--layout-end-justified);
        @apply(--layout-horizontal);
        @apply(--layout-flex);
      }

      #instructions {
        display: block;
        height: 50px;
        word-wrap: break-word;

        @apply(--layout-flex);
      }

      paper-material {
        background-color: var(--gn-notification-background, #fff);
        height: 50px;
        width: 50px;
        margin-left: 10px;
        margin-right: 10px;

        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      #turnIcon {
        color: #00960a;
        margin: auto;

        --iron-icon-width: 48px;
        --iron-icon-height: 48px;
      }

      #notifications {
        left: 0;
        margin: auto;
        position: absolute;
        right: 0;
        top: 74px;
        z-index: 2;

        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
      }
    </style>

    <iron-ajax  id="ajax"
                url="turn-instructions.json"
                last-response="{{_turnInstructionSource}}" auto></iron-ajax>

    <div id="directions">
      <div id="left-container">
        <div class="distance" hidden$="{{!distance}}">{{distance}}</div>
        <div class="distance" hidden$="{{!distance}}">{{unit}}</div>
        <paper-material elevation="5">
          <iron-icon id="turnIcon" icon="[[turnIcon]]"></iron-icon>
        </paper-material>
      </div>
      <div id="instructions">{{instruction}}</div>
    </div>
    <div id="notifications"/>
  </template>

  <script>
    Polymer({
      is: 'gn-notification-container',

      properties: {
        /**
        * Driving instructions.
        */
        instruction: {
          type: String,
          value: "",
          readonly: true
        },

        /**
        * Number which encodes instructions.
        */
        turnCode: {
          type: Number,
          value: 0
        },

        /**
        * Turn icon source
        */
        turnIconSource: {
          type: Object,
          value: function() {
            return {
              0: "",
              1: "arrow-upward",
              2: "arrow-back",
              3: "arrow-forward",
              4: "arrow-back",
              5: "arrow-forward",
              6: "undo",
              7: "redo",
              20: "av:replay",
              21: "arrow-forward"
            };
          }
        },

        turnIcon: {
          type: String,
          value: "arrow-upward"
        },

        /**
        * Sets the language of turn instructions.
        */
        locale: {
          type: String,
          value: "en"
        },

        /**
        * Json source for turn instructions in different languages.
        */
        _turnInstructionSource : {
          type: Object,
          value: function() {
            return {};
          }
        },

        /**
        * Temporary Array for instructions. In future this will
        * possibly be outsourced.
        */
        _turnInstructions: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
        * Distance value.
        */
        distance: {
          type: Number,
          value: 0
        },

        /**
        * Unit of distance.
        */
        unit: {
          type: String,
          value: "m"
        },

        /**
        * Notification object which should look like following.
        * { title: "", icon: "", type: "", persist: false/true }
        */
        newestNotification: {
          type: Object
        },

        _notificationStack: {
          type: Array,
          value: function() {
            return [];
          }
        }
      },

      observers: [
        "addNotification(newestNotification)",
        "_getTurnInstruction(turnCode)",
        "_setTurnInstructionSource(locale, _turnInstructionSource)"
      ],

      /**
      * Sets the source for turn instructions in respect to the `locale` setting.
      */
      _setTurnInstructionSource: function(locale, _turnInstructionSource) {
        this._turnInstructions = _turnInstructionSource[locale]
      },

      _getTurnInstruction: function(turnCode) {
        if (this._turnInstructions !== undefined) {
          var turn = this._turnInstructions.filter(function (o) {
            return o.turn === turnCode;
          });
          this.set("instruction", turn[0].text);
          this.turnIcon = this.turnIconSource[turnCode];
        }
      },

      addNotification: function(newestNotification) {
        var notifications = this.$.notifications;
        // var lastNotification = Polymer.dom(notifications).childNodes[0];
        var notification = document.createElement("gn-route-notification");
        // notification.class = "swipe";
        notification.title = newestNotification.title;
        notification.icon = newestNotification.icon;
        if (newestNotification.type !== "") {
          notification.setAttribute(newestNotification.type, true);
        }
        notification.persist = newestNotification.persist;
        // var lastNotification = document.querySelector("gn-route-notification");
        // if (lastNotification !== null) {
        //   lastNotification.hide();
        // }
        Polymer.dom(notifications).appendChild(notification);
      },

      removeNotification: function() {
        var notifications = this.$.notifications;
        var lastNotification = Polymer.dom(notifications).childNodes[0];
        if (Polymer.dom(notifications).children.length > 0) {
          Polymer.dom(notifications).removeChild(lastNotification);
        }
      }
    });
  </script>
</dom-module>
